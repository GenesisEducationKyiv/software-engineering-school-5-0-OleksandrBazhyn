# Email Service - Моніторинг та Логування

## Оглядметрики та логування

Цей сервіс реалізує комплексну систему логування та моніторингу для забезпечення надійної роботи email-сервісу.

## Рівні логування

Система використовує чотири основні рівні логування:

### 1. **DEBUG** 
- Детальна діагностична інформація
- Стан черги email'ів
- Параметри обробки запитів
- Використовується тільки в development режимі

### 2. **INFO**
- Нормальна робота системи
- Успішна відправка email'ів
- Початок та завершення операцій
- HTTP запити та відповіді
- Підключення до зовнішніх сервісів

### 3. **WARN** 
- Можливі проблеми, що не блокують роботу
- Повторні спроби відправки email'ів
- HTTP відповіді 4xx
- Сповільнення обробки запитів

### 4. **ERROR**
- Критичні помилки
- Невдалі відправки email'ів після всіх спроб
- Збої підключення до зовнішніх сервісів
- HTTP відповіді 5xx
- Виключення та stack traces

## Семплінг логів

Система використовує різні рівні семплінгу для оптимізації продуктивності:

- **Development**: 100% семплінг для всіх рівнів
- **Production**: 
  - ERROR та WARN: 100% (завжди логуються)
  - INFO та DEBUG: 10% семплінг (кожен 10-й лог)

## Метрики

### Бізнес-метрики
- `emails_sent_total` - загальна кількість відправлених email'ів
- `emails_failed_total` - загальна кількість невдалих відправок
- `confirmation_emails_total` - кількість email'ів підтвердження
- `weather_emails_total` - кількість погодних email'ів
- `email_retries_total` - кількість повторних спроб

### Технічні метрики
- `email_processing_duration_seconds` - час обробки email'ів
- `email_queue_size` - розмір черги email'ів
- `http_requests_total` - загальна кількість HTTP запитів
- `http_request_duration_seconds` - час обробки HTTP запитів
- `active_connections` - кількість активних з'єднань

## Алерти для моніторингу

### Критичні алерти (P1)

#### 1. Високий рівень помилок email'ів
```yaml
alert: HighEmailFailureRate
expr: (rate(emails_failed_total[5m]) / rate(emails_sent_total[5m])) > 0.1
for: 2m
severity: critical
description: "Більше 10% email'ів не доставляються протягом 5 хвилин"
```
**Обґрунтування**: Високий відсоток невдалих доставок вказує на серйозні проблеми з SMTP сервером або конфігурацією.

#### 2. Сервіс недоступний
```yaml
alert: EmailServiceDown
expr: up{job="email-service"} == 0
for: 1m
severity: critical
description: "Email сервіс недоступний"
```
**Обґрунтування**: Повна недоступність сервісу критично впливає на функціональність системи.

#### 3. Черга email'ів переповнена
```yaml
alert: EmailQueueTooLarge
expr: email_queue_size > 1000
for: 5m
severity: critical
description: "Черга email'ів містить більше 1000 повідомлень"
```
**Обґрунтування**: Велика черга може вказувати на проблеми з обробкою або перевантаження системи.

### Попереджувальні алерти (P2)

#### 4. Повільна обробка email'ів
```yaml
alert: SlowEmailProcessing
expr: histogram_quantile(0.95, rate(email_processing_duration_seconds_bucket[5m])) > 10
for: 5m
severity: warning
description: "95% email'ів обробляються довше 10 секунд"
```
**Обґрунтування**: Повільна обробка може призвести до накопичення черги та погіршення користувацького досвіду.

#### 5. Високий рівень повторних спроб
```yaml
alert: HighRetryRate
expr: rate(email_retries_total[5m]) > 1
for: 3m
severity: warning
description: "Більше 1 повторної спроби на секунду"
```
**Обґрунтування**: Часті повторні спроби вказують на нестабільність зовнішніх сервісів.

#### 6. Високе навантаження HTTP
```yaml
alert: HighHTTPLatency
expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
for: 5m
severity: warning
description: "95% HTTP запитів обробляються довше 1 секунди"
```
**Обґрунтування**: Повільні HTTP відповіді можуть вказувати на проблеми з продуктивністю або перевантаження.

### Інформаційні алерти (P3)

#### 7. Низька активність
```yaml
alert: LowEmailActivity
expr: rate(emails_sent_total[1h]) < 0.1
for: 30m
severity: info
description: "Менше 0.1 email/секунду протягом години"
```
**Обґрунтування**: Необхідно відслідковувати аномально низьку активність для виявлення можливих проблем.

#### 8. Помилки логування
```yaml
alert: LoggingErrors
expr: increase(winston_logs_error_total[5m]) > 10
for: 2m
severity: warning
description: "Більше 10 помилок логування за 5 хвилин"
```
**Обґрунтування**: Помилки в системі логування можуть ускладнити діагностику проблем.

## Політика зберігання логів (Log Retention Policy)

### Структура зберігання

```
logs/
├── dev.log              # Development логи
├── dev-error.log        # Development помилки
├── prod.log             # Production всі логи
├── prod-error.log       # Production помилки
├── prod-warn.log        # Production попередження
└── archived/            # Архівовані логи
    ├── 2024/
    └── 2025/
```

### Терміни зберігання

#### **ERROR логи**
- **Активне зберігання**: 90 днів
- **Архівування**: 1 рік (стиснуті)
- **Загальне зберігання**: 3 роки
- **Обґрунтування**: Критичні помилки потребують тривалого аналізу для виявлення патернів та трендів

#### **WARN логи**
- **Активне зберігання**: 60 днів
- **Архівування**: 6 місяців (стиснуті)
- **Загальне зберігання**: 1 рік
- **Обґрунтування**: Попередження важливі для аналізу потенційних проблем

#### **INFO логи**
- **Активне зберігання**: 30 днів
- **Архівування**: 3 місяці (стиснуті)
- **Загальне зберігання**: 6 місяців
- **Обґрунтування**: Операційні логи потрібні для короткострокового аналізу та аудиту

#### **DEBUG логи**
- **Активне зберігання**: 7 днів
- **Архівування**: не архівуються
- **Загальне зберігання**: 7 днів
- **Обґрунтування**: Діагностичні логи потрібні тільки для оперативного дебагінгу

### Процес ротації та архівування

#### Щоденна ротація
```bash
# Ротація файлів (виконується щодня о 00:00)
mv prod.log prod-$(date +%Y%m%d).log
mv prod-error.log prod-error-$(date +%Y%m%d).log
mv prod-warn.log prod-warn-$(date +%Y%m%d).log
```

#### Тижнева архівація
```bash
# Стиснення старих логів (виконується щонеділі)
find logs/ -name "*.log" -mtime +7 -exec gzip {} \;
```

#### Місячне очищення
```bash
# Видалення старих логів відповідно до політики
find logs/ -name "prod-error-*.log.gz" -mtime +90 -delete
find logs/ -name "prod-warn-*.log.gz" -mtime +60 -delete
find logs/ -name "prod-*.log.gz" -mtime +30 -delete
find logs/ -name "dev-*.log*" -mtime +7 -delete
```

### Моніторинг дискового простору

#### Алерт на заповнення диска
```yaml
alert: LogDiskSpaceHigh
expr: (node_filesystem_avail_bytes{mountpoint="/var/log"} / node_filesystem_size_bytes{mountpoint="/var/log"}) < 0.1
for: 5m
severity: warning
description: "Менше 10% вільного місця на диску з логами"
```

### Безпека та відповідність

#### Шифрування
- Архівовані логи шифруються AES-256
- Активні логи захищені правами доступу 600

#### Аудит доступу
- Всі операції з архівованими логами логуються
- Доступ до логів обмежений авторизованим користувачам

#### GDPR відповідність
- Email адреси в логах маскуються (abc***@domain.com)
- Можливість повного видалення логів за запитом користувача
- Автоматичне видалення персональних даних після закінчення терміну зберігання

### Відновлення після аварій

#### Резервне копіювання
- Щоденне резервне копіювання критичних логів
- Зберігання резервних копій у віддаленому сховищі
- Тестування відновлення щомісяця

#### План відновлення
1. Визначення обсягу втрачених даних
2. Відновлення з найближчої резервної копії
3. Аналіз причин втрати даних
4. Впровадження додаткових заходів захисту

Ця політика забезпечує баланс між доступністю даних для діагностики, вимогами до зберігання місця та відповідністю регуляторним вимогам.
